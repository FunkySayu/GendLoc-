<!doctype html>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://underscorejs.org/underscore.js"></script>
    <script src="http://sugarjs.com/release/current/sugar.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>
    <script src="/js/adapter.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <script src="/socket.io/socket.io.js"></script>
    <script>
        (function ($) {

            /** CONFIG **/
            var SIGNALING_SERVER = "";
            var MICROPHONE_OK = false;
            var CHANNELS = [];
            var USERS = {};
            var MUTED = [];
            var COMMENT = [];
            var rightClick = null;
            var NAME = "Victime";
            var ICE_SERVERS = [
                {url: "stun:stun.l.google.com:19302"}
            ];
            var CHAT_AUTOSCROLL = true;
            /* Chat is autoscrolling by default */

            var signaling_socket = null;
            /* our socket.io connection to our webserver */
            var local_media_stream = null;
            /* our own microphone / webcam */
            var peers = {};
            /* keep track of our peer connections, indexed by peer_id (aka socket.io id) */
            var peer_media_elements = {};
            /* keep track of our <audio> tags, indexed by peer_id */

            /** Utilities functions **/

            $.get("views/signForms.html", function (signForms) {
                $('.container').append(signForms);
                $('#sign-in-form').on('submit', signin);
                $('#sign-up-form').on('submit', signup);
            });

            function zazuPanel() {
                $.get("views/zazuPanel.html", function (panel) {
                    $('.container').append(panel);
                    setup_local_media(init);
                });
            }

            function signin() {
                console.log('signin');
                var name = $('#si-nameInput').val();
                var password = $('#si-passwordInput').val();
                if (name !== "") {
                    $.post('signin', {username: name, password: password}, function (data) {
                        if (data.err === 0) {
                            NAME = data.message;
                            TOKEN = data.token;
                            console.log(TOKEN);
                            $('#signForms').remove();
                            zazuPanel();
                        } else {
                            $('#sign-in-form .form-group').slice(0, 2).addClass('has-error');
                            setTimeout(function () {
                                $('#sign-in-form .form-group').slice(0, 2).removeClass('has-error')
                            }, 1000);
                        }
                    });
                } else
                    $('#sign-in-form .form-group').slice(0, 1).addClass('has-error');
                setTimeout(function () {
                    $('#sign-in-form .form-group').slice(0, 1).removeClass('has-error')
                }, 1000);

            }

            function signup() {
                console.log('signup');
                var name = $('#su-nameInput').val();
                var password = $('#su-passwordInput').val();
                if (password === $('#su-repeatPasswordInput').val()) {
                    $.post('signup', {username: name, password: password}, function (data) {
                        if (data.err === 0) {
                            NAME = data.message;
                            TOKEN = data.token;
                            $('#signForms').remove();
                            zazuPanel();
                        } else {
                            $('#sign-up-form .form-group').slice(0, 1).toggleClass('has-error');
                            setTimeout(function () {
                                $('#sign-up-form .form-group').slice(0, 1).toggleClass('has-error')
                            }, 1000);
                        }
                    });
                } else {
                    $('#sign-up-form .form-group').slice(1, 3).addClass('has-error');
                    setTimeout(function () {
                        $('#sign-up-form .form-group').slice(1, 3).removeClass('has-error')
                    }, 1000);
                }
            }

            function isJSON(val) {
                if (typeof(val) == 'string')
                    return false;
                try {
                    var jsons = JSON.stringify(val);
                    var json = JSON.parse(jsons);
                }
                catch (e) {
                    return false;
                }
                return true;
            }

            function timestamp_to_time(timestamp) {
                var date = new Date(timestamp * 1000);
                var hours = date.getHours();
                var minutes = "0" + date.getMinutes();
                var seconds = "0" + date.getSeconds();
                return hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
            }

            function urlParam(name) {
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                if (results == null) {
                    return null;
                } else {
                    return results[1] || 0;
                }
            }

            /** Chat functions **/



            function join_server(channel) {
                signaling_socket.emit('joinServer', channel);
            }

            function part_chat_channel(channel) {
                signaling_socket.emit('part', channel);
            }

            function create_menu(menu) {

                res = $("#listChannels");

                for (var i = 0; i < menu.length; i++) {
                    if (isJSON(menu[i])) {
                        add =
                                "<li>" +
                                "<div data-id-channel='" + menu[i].id + "'>" +
                                "<span class='glyphicon glyphicon-triangle-bottom'></span> " +
                                "<span data-bind-id='" + menu[i].id + "'>" + menu[i].name + "</span>";
                        if (menu[i].description) add += "<span class='fa fa-bookmark" + ((!menu[i].toRead) ? "-o" : "") + " pull-right'></span>";
                        add +=
                                "</div>" +
                                "<ul id='channelmenu_" + menu[i].id + "'>"
                        for (var j = 0; j < menu[i].sockets.length; j++) {
                            var glyph = (MUTED.includes(menu[i].sockets[j])) ? "glyphicon-volume-off" : "glyphicon-volume-up";
                            add += "<li>" +
                                    "<div data-id-user='" + menu[i].sockets[j] + "'>" +
                                    "<span class='glyphicon " + glyph + "'></span> " +
                                    "<span data-bind-id='" + menu[i].sockets[j] + "'>" + USERS[menu[i].sockets[j]].name + "</span>";
                            if (COMMENT[menu[i].sockets[j]]) add += "<span class='fa fa-star pull-right'></span>";
                            add += "</div></li>";
                        }
                        add += "</ul></li>";
                        if (menu[i].father !== null)
                            $('#channelmenu_' + menu[i].father).append(add)
                        else
                            $('#listChannels').append(add);
                    } else
                        console.log("Channels list not valid")
                }
                ;

                $('#listChannels').find('div[data-id-channel]')
                        .on('click', function (e) {
                            console.log('Left click on ' + $(this).text());
                        })
                        .on('dblclick', function (e) {
                            channel = $(this).data().idChannel;
                            join_server(channel);
                        })
            }

            /** Local media actions **/

            function setup_local_media(callback, errorback) {
                if (local_media_stream != null) {  /* ie, if we've already been initialized */
                    if (callback) callback();
                    return;
                }
                /* Ask user for permission to use the computers microphone and/or camera,
                 * attach it to an <audio> or <video> tag if they give us access. */
                console.log("Requesting access to local audio / video inputs");
                getUserMedia({"audio": true},
                        function (stream) { /* user accepted access to a/v */
                            console.log("Access granted to audio/video");
                            local_media_stream = stream;
                            var local_media = $("<audio style='display: none'>");
                            local_media.attr("autoplay", "autoplay");
                            local_media.attr("controls", "");
                            local_media.attr('id', "myAudio");
                            attachMediaStream(local_media[0], stream);
                            MICROPHONE_OK = true;
                            if (callback) callback();
                        },
                        function () { /* user denied access to a/v */
                            console.log("Access denied for audio/video");
                            var controlPanelElement = $('#control-panel');
                            controlPanelElement.append("<div>" +
                                    "<h5>Your settings</h5>" +
                                    "</div>"
                                    + "<div id='self-panel-container'>"
                                    + "<input type='button' id='changeNameButton' class='btn btn-sm btn-primary' value='Change username'>"
                                    + "<br>");
                            $('#changeNameButton').on('click', change_username);
                            controlPanelElement.append('<div><h5>Channel users</h5><br></div>');
                            if (callback) callback();
                        });
            }

            function init() {
                /** Listeners initialization on socket **/

                signaling_socket = io.connect(SIGNALING_SERVER, {query: "token=" + TOKEN + "&microphone_ok=" + MICROPHONE_OK});

                /** Connect actions **/

                signaling_socket.on('connect', function () {
                    console.log("Connected to signaling server");
                });

                signaling_socket.on('tokenAccepted', function () {
                    console.log("Connected to Zazu with valid token")
                    /*if (urlParam('room') !== null) {
                     join_server(urlParam('room'));
                     }*/
                    signaling_socket.emit('hasConnected');
                });

                signaling_socket.on('disconnect', function () {
                    console.log("Disconnected from signaling server");
                    /* Tear down all of our peer connections and remove all the
                     * media divs when we disconnect */
                    for (peer_id in peer_media_elements) {
                        peer_media_elements[peer_id].remove();
                    }
                    for (peer_id in peers) {
                        peers[peer_id].close();
                    }
                    peers = {};
                    peer_media_elements = {};
                    $('div.row').remove();
                    $('.container').append('<h3>You have been disconnected</h3>');
                });

                /** Channel actions **/

                signaling_socket.on('joinSuccess', function (channel) {
                    for (peer_id in peer_media_elements)
                        peer_media_elements[peer_id].remove();
                    console.log("Join channel : " + decodeURI(channel));
                })

                /** User interactions **/

                signaling_socket.on('listChannels', function (channels) {
                    for (id in channels) {
                        if (CHANNELS[id]) {
                            if (!CHANNELS[id].toRead && (CHANNELS[id].description !== channels[id].description)) CHANNELS[id].toRead = true;
                            CHANNELS[id] = Object.merge(CHANNELS[id], channels[id]);
                        } else {
                            CHANNELS[id] = channels[id];
                            if (!CHANNELS[id].toRead && CHANNELS[id].description) CHANNELS[id].toRead = true;
                        }
                    }
                    $('#listChannels').empty();
                    create_menu(CHANNELS);
                })

                signaling_socket.on('listNames', function (names) {
                    for (id in names) {
                        if (USERS[id]) USERS[id].name = names[id];
                        else USERS[id] = {name: names[id]};
                    }
                    $('#listChannels').empty();
                    create_menu(CHANNELS);
                })

                signaling_socket.on('localChange', function (change) {
                    console.log(change);
                    switch (change.code) {
                        case "name":
                            USERS[change.author_id].name = change.name;
                            $("span[data-bind-id='" + change.author_id + "'").html(change.name);
                            break;
                        case "channel":
                            CHANNELS[change.channel_id].name = change.name;
                            $("span[data-bind-id='" + change.channel_id + "'").html(change.name);
                            break;
                        default:
                            console.log('wtf?');
                            break;
                    }
                });

                signaling_socket.emit('getListChannelsAndNames');

                //getListChannelsAndNamesInterval = setInterval(getListChannelsAndNames, 200)

                /** WebRTC functions **/

                /**
                 * When we join a group, our signaling server will send out 'addPeer' events to each pair
                 * of users in the group (creating a fully-connected graph of users, ie if there are 6 people
                 * in the channel you will connect directly to the other 5, so there will be a total of 15
                 * connections in the network).
                 */
                signaling_socket.on('addPeer', function (config) {
                    console.log('Signaling server said to add peer:', config);
                    var peer_id = config.peer_id;
                    var peer_connection = new RTCPeerConnection(
                            {"iceServers": ICE_SERVERS},
                            {"optional": [{"DtlsSrtpKeyAgreement": true}]} /* this will no longer be needed by chrome
                             * eventually (supposedly), but is necessary
                             * for now to get firefox to talk to chrome */
                    );
                    peers[peer_id] = peer_connection;
                    peer_connection.onicecandidate = function (event) {
                        if (event.candidate) {
                            signaling_socket.emit('relayICECandidate', {
                                'peer_id': peer_id,
                                'ice_candidate': {
                                    'sdpMLineIndex': event.candidate.sdpMLineIndex,
                                    'candidate': event.candidate.candidate
                                }
                            });
                        }
                    }
                    peer_connection.onaddstream = function (event) {
                        console.log("onAddStream", event);
                        var remote_media = $("<audio style='display: none'>");
                        remote_media.attr("autoplay", "autoplay");
                        remote_media.attr("controls", "");
                        remote_media.attr("id", 'audio_' + peer_id);
                        console.log(peer_id.from(2));

                        // TODO : here create channel

                        /*$('#control-panel').append('<div id="' + peer_id.from(2) + '"></div>');
                         $('#' + peer_id.from(2)).append(remote_media);
                         $('#' + peer_id.from(2)).append("<div class='user-panel-container'><b>" + USERS[peer_id].name + "</b> :<br>");
                         $('#' + peer_id.from(2)).append("<div class='user-controls-container'>"
                         + "<div class='remote-user-mute-container' style='display: inline' data-peer-id='" + peer_id + "'>"
                         + "<a class='btn btn-sm ui-button remote-user-mute-button' href='#' data-toggle='tooltip' title='Mute " + USERS[peer_id].name + "' data-placement='bottom'>"
                         + "<i class='fa fa-volume-up remote-user-mute-icon'></i>"
                         + "</a>"
                         + "</div>"
                         + "<div class='user-volume-range-container' style='display: inline-block; top: 6px;position: relative;'><input class='custom-range' type='range' min='0' max='1' step='0.01' value='1' data-peer-id='" + peer_id + "'></div>"
                         + "</div></div>");
                         $('.remote-user-mute-container').off('click').on('click', toggle_user_stream);
                         $('.custom-range').off().on('input', set_user_volume).on('change', set_user_volume);
                         $('#' + peer_id.from(2)).find('[data-toggle="tooltip"]').tooltip();
                         */
                        peer_media_elements[peer_id] = $('#' + peer_id.from(2));
                        attachMediaStream(remote_media[0], event.stream);
                    }

                    /* Add our local stream */
                    peer_connection.addStream(local_media_stream);
                    /* Only one side of the peer connection should create the
                     * offer, the signaling server picks one to be the offerer.
                     * The other user will get a 'sessionDescription' event and will
                     * create an offer, then send back an answer 'sessionDescription' to us
                     */
                    if (config.should_create_offer) {
                        console.log("Creating RTC offer to ", peer_id);
                        peer_connection.createOffer(
                                function (local_description) {
                                    console.log("Local offer description is: ", local_description);
                                    peer_connection.setLocalDescription(local_description,
                                            function () {
                                                signaling_socket.emit('relaySessionDescription',
                                                        {'peer_id': peer_id, 'session_description': local_description});
                                                console.log("Offer setLocalDescription succeeded");
                                            },
                                            function () {
                                                Alert("Offer setLocalDescription failed!");
                                            }
                                    );
                                },
                                function (error) {
                                    console.log("Error sending offer: ", error);
                                });
                    }
                });

                /**
                 * Peers exchange session descriptions which contains information
                 * about their audio / video settings and that sort of stuff. First
                 * the 'offerer' sends a description to the 'answerer' (with type
                 * "offer"), then the answerer sends one back (with type "answer").
                 */
                signaling_socket.on('sessionDescription', function (config) {
                    console.log('Remote description received: ', config);
                    var peer_id = config.peer_id;
                    var peer = peers[peer_id];
                    var remote_description = config.session_description;
                    console.log(config.session_description);
                    var desc = new RTCSessionDescription(remote_description);
                    var stuff = peer.setRemoteDescription(desc,
                            function () {
                                console.log("setRemoteDescription succeeded");
                                if (remote_description.type == "offer") {
                                    console.log("Creating answer");
                                    peer.createAnswer(
                                            function (local_description) {
                                                console.log("Answer description is: ", local_description);
                                                peer.setLocalDescription(local_description,
                                                        function () {
                                                            signaling_socket.emit('relaySessionDescription',
                                                                    {
                                                                        'peer_id': peer_id,
                                                                        'session_description': local_description
                                                                    });
                                                            console.log("Answer setLocalDescription succeeded");
                                                        },
                                                        function () {
                                                            Alert("Answer setLocalDescription failed!");
                                                        }
                                                );
                                            },
                                            function (error) {
                                                console.log("Error creating answer: ", error);
                                                console.log(peer);
                                            });
                                }
                            },
                            function (error) {
                                console.log("setRemoteDescription error: ", error);
                            }
                    );
                    console.log("Description Object: ", desc);
                });

                /**
                 * The offerer will send a number of ICE Candidate blobs to the answerer so they
                 * can begin trying to find the best path to one another on the net.
                 */
                signaling_socket.on('iceCandidate', function (config) {
                    var peer = peers[config.peer_id];
                    var ice_candidate = config.ice_candidate;
                    peer.addIceCandidate(new RTCIceCandidate(ice_candidate));
                });

                /**
                 * When a user leaves a channel (or is disconnected from the
                 * signaling server) everyone will recieve a 'removePeer' message
                 * telling them to trash the media channels they have open for those
                 * that peer. If it was this client that left a channel, they'll also
                 * receive the removePeers. If this client was disconnected, they
                 * wont receive removePeers, but rather the
                 * signaling_socket.on('disconnect') code will kick in and tear down
                 * all the peer sessions.
                 */
                signaling_socket.on('removePeer', function (config) {
                    console.log('Signaling server said to remove peer:', config);
                    var peer_id = config.peer_id;
                    if (peer_id in peer_media_elements) {
                        peer_media_elements[peer_id].remove();
                    }
                    if (peer_id in peers) {
                        peers[peer_id].close();
                    }
                    delete peers[peer_id];
                    delete peer_media_elements[config.peer_id];
                });
            }
        })(jQuery);
    </script>

</head>
<body>
<div class="container">
    <h1 style="text-align: center">Gendloc Video</h1>
    <hr>
</div>

</body>
</html>
